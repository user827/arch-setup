#!/bin/sh
set -eu

gpguser=sb
gpghome=/usr/share/grubkeys

if [ "$1" = --export ]; then
  gpg --homedir "$gpghome"  --batch --no-tty --local-user "$gpguser" --export
  exit 0
fi

if [ "$1" = --verify ]; then
  gpg --homedir "$gpghome" --local-user "$gpguser" --verify "$2"
  exit 0
fi

if [ "$1" = --init ]; then
  if ! [ -f "$gpghome"/pubring.kbx ]; then
    mkdir -m700 "$gpghome"
    gpg --homedir "$gpghome" --batch --no-tty --passphrase '' --quick-gen-key "$gpguser" rsa4096 default never
  else
    echo "grubsign already initialized" >&2
  fi
  exit 0
fi

if [ "$1" = --sign-all ]; then
  for f in /boot/vmlinuz* /boot/*.img; do
    [ -f "$f" ] || continue
    [ "${f%.sig}" = "$f" ] || continue
    grubsign "$f"
  done
  exit 0
fi

if [ "$1" = -- ]; then
  shift
fi

file=$1
if [ -f "$file.sig" ]; then
  echo "overwriting signature of $file"
  rm "$file.sig"
else
  echo "signing $file"
fi
gpg --homedir "$gpghome" --batch --no-tty --local-user "$gpguser" --detach-sign "$file"
